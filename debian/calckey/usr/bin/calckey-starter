#!/usr/bin/env bash

set -euo pipefail
[ "${TRACE:-false}" = 'true' ] && set -x

WORKDIR=/var/lib/calckey/live

if [ "$(pwd)" != "$WORKDIR" ] || [ "$USER" != 'calckey' ]; then
    echo "Invalid working directory or user."
    exit 1
fi

if [ "${RUN_MIGRATION_ON_START:-false}" = 'true' ]; then
    (cd "$WORKDIR/packages/backend" && npx typeorm migration:run -d ormconfig.js)
    (cd "$WORKDIR/packages/backend" && ./native-utils/built/migration up)
fi

exec node "$WORKDIR/packages/backend/built/index.js"
