name: Deploy for amd64 / Debian bookworm

on:
    push:
        branches: [ "main" ]
        tags: [ "*" ]
    pull_request:
        branches: [ "main" ]

env:
    REGISTRY: ghcr.io
    BASE_IMAGE_NAME: ${{ github.repository }}-base

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        outputs:
            image: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}:${{ steps.meta.outputs.tags[0] }}

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v3

            -   name: Log in to the Container registry
                uses: docker/login-action@v2
                with:
                    registry: ${{ env.REGISTRY }}
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Extract metadata (tags, labels) for Docker
                id: meta
                uses: docker/metadata-action@v4
                with:
                    images: ${{ env.REGISTRY }}/${{ env.BASE_IMAGE_NAME }}

            -   name: Build and push Docker image
                uses: docker/build-push-action@v4
                with:
                    context: ./debian/
                    push: true
                    target: base
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}

    build-deb:
        runs-on: ubuntu-latest
        needs: ["build-image"]
        container:
            image: ${{ needs.build-image.outputs.image }}
            credentials:
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}

        steps:
            -   name: Checkout repository
                uses: actions/checkout@v3

            -   name: Build
                run: env TRACE=true ./debian/scripts/build-source

            -   name: Build deb
                run: env TRACE=true ./debian/scripts/build-deb

            -   name: Test
                run: env TRACE=true ./debian/scripts/test

            -   name: Release
                uses: softprops/action-gh-release@v1
                if: startsWith(github.ref, 'refs/tags/')
                with:
                    files: |
                        ./debian/install/*.deb
